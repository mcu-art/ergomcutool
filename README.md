# ergomcutool

[![Ubuntu-latest](https://github.com/mcu-art/ergomcutool/actions/workflows/ubuntu-latest.yml/badge.svg)](https://github.com/mcu-art/ergomcutool/actions/workflows/ubuntu-latest.yml)
[![Ubuntu-coverage](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/mcu-art/e32e37141973c5d7c3d84cacadaac090/raw/ergomcutool-codecov-ubuntu.json)](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/mcu-art/e32e37141973c5d7c3d84cacadaac090/raw/ergomcutool-codecov-ubuntu.json)

**ergomcutool** is a small, simple and intuitive project manager
that helps to integrate STM32 projects generated by STM32CubeMX into VSCode.
It provides a convenient way to manage STM32 projects on linux.

## What are the benefits of ergomcutool?
STM32CubeMX already has an ability to generate Makefiles and CMake files. But there are still some issues with VSCode integration
that make the workflow more complicated than needed.

Benefits of `ergomcutool`:
+ less boilerplate to do manually
+ separation of machine-dependent settings and committable project settings
+ separation of concerns: you manage your files, STM32CubeMX manages its
+ automatic handling of VSCode intellisense


## Prerequisites
+ Linux OS (future versions may support Windows and MacOS).
  This guide was tested on Ubuntu 22.04.1.

+ STM32CubeMX
  https://www.st.com/en/development-tools/stm32cubemx.html

+ GNU ARM compiler:
```bash
sudo apt-get install gcc-arm-none-eabi
arm-none-eabi-gcc --version
# arm-none-eabi-gcc (15:10.3-2021.07-4) 10.3.1 20210621 (release)
```

+ openocd (On-Chip Debugger)
```bash
sudo apt-get install openocd
openocd --version
# Open On-Chip Debugger 0.11.0
```

+ gdb-multiarch
```bash
sudo apt-get install gdb-multiarch
gdb-multiarch --version
# GNU gdb (Ubuntu 12.1-0ubuntu1~22.04) 12.1
```
If `gdb-multiarch` can't be installed with `apt-get` due to a version conflict bug,
try installing it from a .deb file manually, e.g.
`http://archive.ubuntu.com/ubuntu/pool/universe/g/gdb/gdb-multiarch_12.1-0ubuntu1~22.04_amd64.deb`

+ ST-Link or similar device for programming and debugging the MCU that is supported by `openocd`.
  A list of the supported devices is usually located in
  `/usr/share/openocd/scripts/interface/` directory on Ubuntu.


## Installation
```bash
go install github.com/mcu-art/ergomcutool@latest

# Initialize ergomcutool
ergomcutool init
```
After installation, edit `~/.ergomcutool/ergomcutool_config.yaml`
to specify your hardware debugger and other settings.


## Quick start
1. Create a new STM32 project with STM32CubeMX or use an existing one.
   Save the project.
   In the `Project Manager` tab select `Toolchain/IDE` Makefile.
   Press `Generate Code `button.

2. Create ergomcu project from the STM32CubeMX project:
   run `ergomcutool create` from the project root directory.

3. Edit the configuration files: `ergomcutool/ergomcu_project.yaml`
   and `_non_persistent/ergomcutool_config.yaml`.
   Other files like `.gitignore` and `.clang-format` may be adjusted as well.

4. Update your project: `ergomcutool update-project`.

5. Build your project `make`

6. Program your device: `make prog`


## Usage

### Setting up VSCode
The following VSCode extensions are required to be installed:
  + `C/C++` by Microsoft
  + `Cortex-Debug` by marus25

The `Makefile Tools` extension by Microsoft doesn't seem to work properly
with STM32CubeMX-generated makefiles and is recommended to be disabled.


### Adding source files to your project
Edit `ergomcutool/ergomcu_project.yaml` to add C source files to your project.
List all your source files in the `c_src` section, e.g.
```yaml
c_src:
  - _external/example_lib/file1.c
  - "{{.EXAMPLE_LIB}}/file2.c"
```

The paths may contain Go template variables defined in the 
`external_dependencies` section, in that case use quotes
to keep yaml syntax valid, e.g.: `"{{.EXAMPLE_LIB}}/file2.c"`.

It is also possible to add all `.c` files from a directory, use `c_src_dirs` for this:
```yaml
c_src_dirs:
  - src_dir_1
  - ../path/to/src_dir_2
```


### Adding C include directories
For adding C include directories to your project use `c_include_dirs`:
```yaml
c_include_dirs:
  - _external/example_lib/include
```
The notes about template variables from section `Adding source files to your project` 
apply here as well.
The paths must not be prefixed with `-I`, the tool will
do it automatically when generating the Makefile.


### Adding C definitions
For adding C definitions into your project use `c_defs`:
```yaml
c_defs:
 - EXAMPLE_DEFINITION
```
The definitions must not be prefixed with `-D`, the tool will
do it automatically when generating the Makefile.


### SVD file
`.svd` (System View Description) files contain information about MCUs that makes
the debugging process more comfortable (register and control bit names etc.).
The debugging can be done without a `.svd` file,
in that case the `XPERIPHERIALS` tab will not be available in VSCode.

The `.svd` files are provided by ST company for each device family and can be downloaded
from their website, e.g.
`https://www.st.com/en/microcontrollers-microprocessors/stm32f103.html#cad-resources`.

If you choose to use an `.svd` file, you have two options:
1. Include it as a part of the project, then you specify
   the path to it in `ergomcutool/ergomcu_project.yaml`.
2. Use an external `.svd` file that is not a part of the project,
   in this case you specify the path to it in `_non_persistent/ergomcutool_config.yaml`.

In case you choose not to use `.svd` file, you may disable the warning
by setting `disable_svd_warning: true` in the `openocd` section in `_non_persistent/ergomcutool_config.yaml`.


### External project dependencies
`ergomcutool` allows adding external dependencies to the project.
The dependencies containing relative paths are supposed to be specified in 
`ergomcutool/ergomcu_project.yaml`.
The dependencies containing absolute paths or machine-specific dependencies
are supposed to be specified in `ergomcutool_config.yaml`
either in the user home directory or in the project directory.

Example:
```yaml
external_dependencies:
 - var:                     EXAMPLE_LIB
   path:                    /path/to/example/lib
   create_in_project_link:  true
   link_name:               example_lib
```

In this example, an external dependency `EXAMPLE_LIB` is defined,
it can be used in the file paths with the following syntax:
```yaml
c_src:
  - "{{.EXAMPLE_LIB}}/src/file1.c"
```
Note the quotes that are required in this case for yaml syntax to be valid.
The `create_in_project_link` setting instructs `ergomcutool`
to create a symlink in `your_project_root/_external/` directory
to the directory specified by `path`.
It is a convenient way to work with external files in VSCode
if you have to view or edit them. If you don't need this functionality,
you may specify `create_in_project_link: false`.
`link_name` specifies the name of the symlink to be created.
The `_external` directory is added to `.gitignore` by default.


### Programming the MCU
To program the MCU, type `make prog` command in the terminal from the project root.
By default, `ergomcutool` adds `prog` target to the makefile based on
`~/.ergomcutool/assets/snippets/prog_task.txt.tmpl` template.

If you need to customize the `prog` target,
do not edit the Makefile directly, instead create file
`ergomcutool/snippets/prog_task.txt.tmpl` in your project directory
and customize it.

The default file contents looks as follows:
```Makefile
prog: $(BUILD_DIR)/$(TARGET).elf
	openocd -f interface/{{.OpenocdInterface}} -f target/{{.OpenocdTarget}} -c "program $(BUILD_DIR)/$(TARGET).elf verify exit reset"
```
This file is a Go template.
There are two template variables here:
  + `{{.OpenocdInterface}}` is the value of `openocd.interface`
    specified in the `ergomcutool_config.yaml`.
  + `{{.OpenocdTarget}}` is the value of `openocd.target`
    specified in the `ergomcu_project.yaml`.

Note: Makefile syntax doesn't allow usage of spaces for indentation,
always use tabs instead.
